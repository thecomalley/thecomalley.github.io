---
slug: packer-proxmox-ubuntu-
title: Building Ubuntu Server 24.04 Templates for Proxmox with Packer
authors: [chris]
tags: [packer, proxmox, ubuntu, iac]
---

# üèóÔ∏è Building Ubuntu Server 24.04 Templates for Proxmox with Packer

![Proxmox and Packer logos side by side](images/proxmox-packer-ubuntu.png)

## üöÄ Introduction

In my homelab journey, I've embraced the "infrastructure as code" (IaC) philosophy. Having everything defined as code brings consistency, repeatability, and version control to my entire infrastructure.

I'm setting up a k3s cluster and Windows Server lab, which means I need to provision quite a few VMs. Clicking through installers definitely isn't very "as code" üòÖ, so I've turned to Packer to build VM templates with all the config needed for Ansible to provision them automatically.

Sure, for Ubuntu I could just download the official [Ubuntu Cloud Images](https://cloud-images.ubuntu.com/), but since I'll need custom images for Windows anyway, I figured I'd build my own Ubuntu templates too. It's always interesting to peek under the hood, plus building custom templates gives me complete control over what's included.

<!-- truncate -->

:::info
Packer is part of the HashiCorp suite of tools designed for modern infrastructure automation. It complements other IaC tools like Terraform and Ansible in a comprehensive code-based infrastructure ecosystem.
:::

## üéØ My Requirements for VM Templates

For my automation workflow to function smoothly, I need VM templates with these specific capabilities:

1. **Proxmox Cloud-Init Integration** - Templates must work seamlessly with Proxmox's cloud-init implementation, allowing me to set usernames and SSH keys either via the GUI or Terraform
      
2. **QEMU Guest Agent** - Must be pre-installed to enable better VM management and status reporting within Proxmox
   
3. **System Configuration** - Proper timezone settings and other baseline configurations

:::tip Why This Matters
This approach creates a seamless automation pipeline: Packer builds the template ‚Üí Terraform deploys VMs from the template with cloud-init customization ‚Üí Ansible immediately connects for configuration management. No manual steps required!
:::

## ‚òÅÔ∏è Understanding Cloud-Init

Before diving into the code, it's important to understand the role of cloud-init in our automation stack.

### What is Cloud-Init?

Cloud-init is the industry standard for early VM initialization. It's a set of Python scripts and utilities that handle the initial setup of a virtual machine, allowing you to:

- Configure hostnames
- Generate SSH keys
- Set up users and passwords
- Install packages
- Run custom scripts

Originally developed for cloud environments like AWS and Azure, cloud-init has become the standard way to customize virtual machines at first boot across many platforms, including Proxmox.

### Why Cloud-Init Matters for Proxmox Templates

Proxmox has built-in support for cloud-init, but there's a bit of magic required to make your templates work seamlessly:

1. **Configuration Sources** - Proxmox uses specific cloud-init data sources that need to be configured in your template
2. **Drive Integration** - When you clone a template, Proxmox automatically attaches a cloud-init drive with your customizations
3. **First-Boot Automation** - Cloud-init runs on the first boot of each VM clone, applying your customizations

:::info
When a template with proper cloud-init configuration is cloned in Proxmox, you can customize the new VM via the GUI or API by setting hostname, IP address, SSH keys, and more - all without having to log in to the VM itself!
:::

[Proxmox cloud-init interface](placeholder-for-proxmox-cloudinit-ui.jpg)
*[Screenshot suggestion: The Proxmox GUI showing the cloud-init configuration panel]*

With a proper understanding of cloud-init, we can now look at how to build our template with Packer.

## üóÇÔ∏è The Template Structure

My Packer template for Ubuntu Server 24.04 is organized as follows:

```
ubuntu-server-24-04/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ ubuntu-server-24-04.pkr.hcl
‚îú‚îÄ‚îÄ variables.pkr.hcl
‚îú‚îÄ‚îÄ my.auto.pkrvars.hcl (excluded from git)
‚îî‚îÄ‚îÄ files/
    ‚îú‚îÄ‚îÄ 99-pve.cfg
    ‚îú‚îÄ‚îÄ meta-data
    ‚îî‚îÄ‚îÄ user-data.pkrtpl.hcl
```

Let's break down each component:

### üìÑ Main Configuration (ubuntu-server-24-04.pkr.hcl)

The main configuration file defines the Packer template for building a Ubuntu Server 24.04 VM template on Proxmox. It starts with the required plugins declaration:

```hcl
packer {
  required_plugins {
    proxmox = {
      version = "~> 1.0"
      source  = "github.com/hashicorp/proxmox"
    }
  }
}
```

Then it sets up templated user-data using a local variable:

```hcl
locals {
  user_data = templatefile("${path.root}/files/user-data.pkrtpl.hcl", {
    ssh_username        = var.ssh_username
    ssh_authorized_keys = join("\n", var.ssh_authorized_keys)
  })
}
```

:::note
The `templatefile` function allows us to use variables within our cloud-init configuration, making the template much more flexible.
:::

The VM template settings are configured with detailed specifications for disk, CPU, memory, networking, and more.

[Packer running build process](placeholder-for-packer-build-terminal.jpg)
*[Screenshot suggestion: Terminal window showing Packer run in progress]*

### üîß Variables (variables.pkr.hcl)

The variables file defines what parameters can be customized:

- `proxmox_node`: The Proxmox node to build on
- `vm_id`: VM ID for the template
- `vm_name`: VM name for the template
- `ssh_username`: Username for SSH connections
- `ssh_authorized_keys`: SSH public keys for the user

### ‚òÅÔ∏è Cloud-Init Configuration (user-data.pkrtpl.hcl)

The cloud-init configuration uses HCL templating to inject variables at build time. This is where we implement several of our key requirements:

```hcl
#cloud-config
autoinstall:
  version: 1
  locale: en_NZ
  keyboard:
    layout: us
  ssh:
    install-server: true
    allow-pw: true
    disable_root: true
    ssh_quiet_keygen: true
    allow_public_ssh_keys: true
  packages:
    - qemu-guest-agent  # Pre-installing QEMU guest agent
  # More configuration...
  user-data:
    package_upgrade: false
    timezone: Pacific/Auckland  # Setting timezone
    users:
      - name: ${ssh_username}
        groups: [adm, sudo]
        sudo: ALL=(ALL) NOPASSWD:ALL
        shell: /bin/bash
        ssh_authorized_keys:  # Pre-installing SSH keys
          - ${ssh_authorized_keys}
```

:::success Meeting Requirements
This configuration takes care of three of our four key requirements: SSH keys, QEMU guest agent, and timezone. The 99-pve.cfg file (shown later) handles the Proxmox cloud-init integration.
:::

## üîê Security and Authentication

For security, I separate authentication from configuration. This means:

:::danger Security Best Practice
Never commit credentials or sensitive tokens to your git repository! Always use environment variables or secure vaults for authentication information.
:::

1. Authentication credentials are stored in environment variables:
   ```sh
   PROXMOX_URL="https://<server>:<port>/api2/json"
   PROXMOX_USERNAME="root"
   PROXMOX_TOKEN="<token>"
   ```

2. Configuration variables are in a `.auto.pkrvars.hcl` file (excluded from git):
   ```hcl
   proxmox_node = "pve"
   ssh_username = "omadmin"
   ssh_authorized_keys = ["ssh-rsa AAAAB3Nz..."]
   ```

[Proxmox API tokens page](placeholder-for-proxmox-tokens-page.jpg)
*[Screenshot suggestion: Proxmox API tokens configuration page (with sensitive data blurred)]*

## üõ†Ô∏è The Installation Process

The Packer process follows these steps:

1. **Start VM**: Boots a VM with the Ubuntu Server 24.04 ISO
2. **Autoinstall**: Uses the boot command to trigger Ubuntu's autoinstall
3. **Cloud-Init**: Configures the system using cloud-init
4. **Provisioning**: Runs shell provisioners to clean up and prepare the VM
5. **Template Creation**: Converts the VM to a template

:::caution
The boot command sequence may vary slightly depending on your Proxmox version and the Ubuntu Server ISO you're using. You might need to adjust the key sequence if you encounter issues.
:::

The boot command is particularly interesting:

```hcl
boot_command = [
  "<esc><wait>",
  "e<wait>",
  "<down><down><down><end>",
  "<bs><bs><bs><bs><wait>",
  "autoinstall ds=nocloud-net\\;s=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ ---<wait>",
  "<f10><wait>"
]
```

This sequence escapes the GRUB menu, modifies the boot parameters to use the autoinstall feature, and points it to the HTTP server that Packer spins up containing our cloud-init configuration.

## üßπ Preparing the Template

After the installation, several cleanup steps prepare the VM for templating:

```hcl
provisioner "shell" {
  inline = [
    "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done",
    "sudo rm /etc/ssh/ssh_host_*",
    "sudo truncate -s 0 /etc/machine-id",
    "sudo apt -y autoremove --purge",
    "sudo apt -y clean",
    "sudo apt -y autoclean",
    "sudo cloud-init clean",
    "sudo rm -f /etc/cloud/cloud.cfg.d/subiquity-disable-cloudinit-networking.cfg",
    "sudo rm -f /etc/netplan/00-installer-config.yaml",
    "sudo sync"
  ]
}
```

:::tip
These cleanup steps are crucial for ensuring that each VM created from this template will have unique identifiers and configurations. Without them, you might encounter networking or SSH issues when deploying multiple VMs.
:::

### ‚òÅÔ∏è Enabling Proxmox Cloud-Init Integration

The most critical part for meeting our first requirement is including a custom cloud-init configuration file to ensure Proxmox's cloud-init integration works correctly:

```hcl
provisioner "file" {
  source      = "files/99-pve.cfg"
  destination = "/tmp/99-pve.cfg"
}

provisioner "shell" {
  inline = ["sudo cp /tmp/99-pve.cfg /etc/cloud/cloud.cfg.d/99-pve.cfg"]
}
```

The `99-pve.cfg` file contains:
```
datasource_list: [ConfigDrive, NoCloud]
```

:::info Critical Configuration
This configuration is what makes the template compatible with Proxmox's cloud-init implementation. It ensures that cloud-init looks for configuration from the right sources when deployed as a VM in Proxmox, allowing you to set usernames and SSH keys via the GUI or Terraform.
:::

![Completed VM template in Proxmox](./images/completed-template.png)

## üöÄ Running the Build

To build the template:

1. Set the environment variables for authentication
2. Create your variables file with the necessary configuration
3. Run Packer:
   ```bash
   packer init .
   packer build .
   ```

:::info
The `packer init` command is important as it downloads and installs the required plugins specified in your configuration.
:::

![Successful Packer build output](./images/successful-build.png)

## üß© Integration with the Automation Pipeline

With our template created, we can now use Use Terraform to Deploy VMs & run Ansible Playbooks Immediately but more on that another day.

## üèÅ Conclusion

Using Packer with Proxmox creates VM templates that perfectly fit into an infrastructure-as-code workflow. By ensuring our templates meet our key requirements - Proxmox cloud-init integration, pre-installed SSH keys, QEMU guest agent, and basic system configuration - we enable a completely automated, code-driven infrastructure.


---

*Shout out to Christian Lempa for his tutorial on Packer and Proxmox: https://www.youtube.com/watch?v=1nf3WOEFq1Y*