"use strict";(self.webpackChunkmy_blog=self.webpackChunkmy_blog||[]).push([[297],{2089:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>u,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>t,toc:()=>l});var t=r(8936),o=r(4848),s=r(8453);const i={slug:"azure-sandbox-nuke",title:"Azure Sandbox Nuke",authors:["chris"],tags:["terraform","azure","python","function-app","devops"]},a="Keeping Azure Costs Under Control with Automated Sandbox Cleanup",u={authorsImageUrls:[void 0]},l=[{value:"Why Even have Sandbox Subscriptions?",id:"why-even-have-sandbox-subscriptions",level:2},{value:"The Problem: Forgotten Resources",id:"the-problem-forgotten-resources",level:2},{value:"The Solution: Azure Sandbox Nuke",id:"the-solution-azure-sandbox-nuke",level:2},{value:"How It Works",id:"how-it-works",level:2},{value:"1. The Core Cleanup Logic",id:"1-the-core-cleanup-logic",level:3},{value:"2. Azure Function Timer Trigger",id:"2-azure-function-timer-trigger",level:3},{value:"3. Notifications via Pushover",id:"3-notifications-via-pushover",level:3},{value:"Infrastructure as Code with Terraform",id:"infrastructure-as-code-with-terraform",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Conclusion",id:"conclusion",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"As cloud engineers and developers working with Azure, we've all been there - forgotten resources silently accumulating costs in our sandbox environments. After one too many surprise bills, I decided to build a solution that would automatically clean up unused resources in Azure subscriptions."}),"\n",(0,o.jsx)(n.p,{children:"There are many tools and scripts available for to accomplish this, But in this blog post i'll share the solution im using to keep my Azure costs under control."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:r(6217).A+"",width:"1200",height:"627"})}),"\n",(0,o.jsx)(n.h2,{id:"why-even-have-sandbox-subscriptions",children:"Why Even have Sandbox Subscriptions?"}),"\n",(0,o.jsx)(n.p,{children:"First of all Sandbox subscriptions are great, For a team to be really productive ideally every engineer should have their own Sandbox subscription, (this is one of the benefits of a Visual Studio Enterprise subscription) When pared with a M365 Development Tenancy this is an ideal personal lab environment, where you can test out new features, try out new services, and experiment with different configurations without worrying about breaking anything in production."}),"\n",(0,o.jsx)(n.h2,{id:"the-problem-forgotten-resources",children:"The Problem: Forgotten Resources"}),"\n",(0,o.jsx)(n.p,{children:"The Monthly Azure credit for Visual Studio Enterprise (MPN) subscribers is $150 USD which can very quickly be consumed if you are not careful."}),"\n",(0,o.jsx)(n.p,{children:"If i need to quickly deploy some resources to test out a use case for a customer and forget to delete them, this can quickly consume my entire credit and then the subscription is disabled until the next month."}),"\n",(0,o.jsx)(n.h2,{id:"the-solution-azure-sandbox-nuke",children:"The Solution: Azure Sandbox Nuke"}),"\n",(0,o.jsx)(n.p,{children:"Azure Sandbox Nuke is a simple Python function app that runs on a schedule to clean up untagged resource groups in Azure subscriptions. It uses the Azure SDK for Python to interact with Azure resources and is deployed using Terraform."}),"\n",(0,o.jsx)(n.p,{children:'The solution works by scanning one or more Azure subscriptions on a daily schedule, identifying resource groups without a specified tag (e.g., "WorkloadName"), and deleting them. It then sends a notification with details of what was removed or any errors encountered.'}),"\n",(0,o.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,o.jsx)(n.p,{children:"The solution consists of three main components:"}),"\n",(0,o.jsx)(n.h3,{id:"1-the-core-cleanup-logic",children:"1. The Core Cleanup Logic"}),"\n",(0,o.jsxs)(n.p,{children:["The main logic is implemented in ",(0,o.jsx)(n.code,{children:"cleaner.py"})," It:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Authenticates with Azure using ",(0,o.jsx)(n.code,{children:"DefaultAzureCredential"})]}),"\n",(0,o.jsx)(n.li,{children:"Lists all resource groups in specified subscriptions"}),"\n",(0,o.jsx)(n.li,{children:"Identifies which ones are missing the required tag (defined by TAG_KEY)"}),"\n",(0,o.jsx)(n.li,{children:"Deletes those resource groups"}),"\n",(0,o.jsx)(n.li,{children:"Builds a summary of deleted and errored resource groups"}),"\n"]}),"\n",(0,o.jsxs)(n.admonition,{type:"tip",children:[(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"DefaultAzureCredential"})," makes authentication super easy by running though each available authentication method (service principal, managed identity, Azure CLI, etc.) until it finds one that works. This means no code changes are needed when switching between local development and production environments."]}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.defaultazurecredential?view=azure-python",children:"More info"})})]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def clean_sub_rgs(subscription_id: str) -> tuple:\n    """\n    Cleans up all resource groups in the given subscription, that are missing a specific tag key.\n    """\n    credentials = DefaultAzureCredential()\n    azurerm = ResourceManagementClient(credentials, subscription_id)\n\n    # list all resource groups\n    resource_groups = azurerm.resource_groups.list()\n\n    deleted_resource_groups = []\n    errored_resource_groups = []\n\n    for resource_group in resource_groups:\n        # Check if the resource group has any tags\n        if resource_group.tags is None:\n            resource_group.tags = {}\n\n        # Check if the resource group has the tag key\n        if TAG_KEY not in resource_group.tags:\n            try:\n                azurerm.resource_groups.begin_delete(resource_group.name)\n                deleted_resource_groups.append(resource_group.name)\n            except Exception as e:\n                errored_resource_groups.append(resource_group.name)\n                \n    return (deleted_resource_groups, errored_resource_groups)\n'})}),"\n",(0,o.jsx)(n.h3,{id:"2-azure-function-timer-trigger",children:"2. Azure Function Timer Trigger"}),"\n",(0,o.jsx)(n.p,{children:"The Azure Function is configured to run on a schedule using a timer trigger:"}),"\n",(0,o.jsx)(n.admonition,{type:"warning",children:(0,o.jsxs)(n.p,{children:["Setting the Timezone is not currently supported on Linux in a Consumption or Flex Consumption plan so we need to set the trigger to UTC. ",(0,o.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer?tabs=python-v2%2Cisolated-process%2Cnodejs-v4&pivots=programming-language-python#ncrontab-time-zones",children:"Source"})]})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"@app.timer_trigger(schedule=\"0 0 8 * * *\", arg_name=\"myTimer\", run_on_startup=True,\n                   use_monitor=False)\ndef clean_rgs(myTimer: func.TimerRequest) -> None:\n    if myTimer.past_due:\n        logging.info('The timer is past due!')\n    clean_resource_groups()\n    logging.info('Python timer trigger function executed.')\n"})}),"\n",(0,o.jsx)(n.h3,{id:"3-notifications-via-pushover",children:"3. Notifications via Pushover"}),"\n",(0,o.jsxs)(n.p,{children:["I like to use ",(0,o.jsx)(n.a,{href:"https://pushover.net/",children:"Pushover"})," for notifications within my lab environments because its free, sends push notifications to my phone and has a dead simple interface with notification history."]}),"\n",(0,o.jsx)(n.p,{children:"After cleaning up resources, a notification is sent using the Pushover service to provide a summary of what happened:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def send_pushover_notification(message: str) -> None:\n    """\n    Sends a notification to a Pushover user.\n    """\n    url = "https://api.pushover.net/1/messages.json"\n    payload = {\n        "token": PUSHOVER_API_TOKEN,\n        "user": PUSHOVER_USER_KEY,\n        "message": message\n    }\n    try:\n        response = requests.post(url, data=payload)\n        response.raise_for_status()\n    except requests.exceptions.RequestException as e:\n        logging.error(f"Failed to send notification: {e}")\n    else:\n        logging.info("Notification sent successfully.")\n'})}),"\n",(0,o.jsx)(n.h2,{id:"infrastructure-as-code-with-terraform",children:"Infrastructure as Code with Terraform"}),"\n",(0,o.jsxs)(n.p,{children:["The entire solution is deployed using Terraform with my custom ",(0,o.jsx)(n.a,{href:"https://github.com/thecomalley/terraform-azurerm-python-function",children:"terraform-azurerm-python-function"})," module, which you can read more about in my ",(0,o.jsx)(n.a,{href:"https://thecomalley.github.io/terraform-azurerm-python-function",children:"previous blog post"}),"."]}),"\n",(0,o.jsx)(n.h2,{id:"deployment",children:"Deployment"}),"\n",(0,o.jsx)(n.p,{children:"Deploying the solution is simple with just three commands:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"export ARM_SUBSCRIPTION_ID=<your-subscription-id>\nterraform init\nterraform apply\n"})}),"\n",(0,o.jsx)(n.p,{children:"After deployment, you'll need to manually set the Pushover credentials in the Key Vault since these are marked as sensitive."}),"\n",(0,o.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,o.jsx)(n.p,{children:"Azure Sandbox Nuke is a straightforward yet effective solution for keeping Azure costs under control. By automatically removing untagged resource groups, it provides a safety net against forgotten resources and encourages good tagging practices."}),"\n",(0,o.jsxs)(n.p,{children:["The complete source code is available on ",(0,o.jsx)(n.a,{href:"https://github.com/thecomalley/azure-sandbox-nuke",children:"GitHub"})," under an MIT license. Feel free to use it, modify it, and let me know if you have any suggestions for improvements!"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.admonition,{type:"danger",children:(0,o.jsxs)(n.p,{children:["This solution is ",(0,o.jsx)(n.strong,{children:"destructive"})," and will delete any resource groups that do not have the specified tag. Use with caution and ensure you have scoped it to the correct subscription and tag key."]})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},6217:(e,n,r)=>{r.d(n,{A:()=>t});const t=r.p+"assets/images/hero-19a0c5bce1f2bc68c2ba86fe5165cad0.png"},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var t=r(6540);const o={},s=t.createContext(o);function i(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(s.Provider,{value:n},e.children)}},8936:e=>{e.exports=JSON.parse('{"permalink":"/azure-sandbox-nuke","editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2025-04-12/index.md","source":"@site/blog/2025-04-12/index.md","title":"Azure Sandbox Nuke","description":"As cloud engineers and developers working with Azure, we\'ve all been there - forgotten resources silently accumulating costs in our sandbox environments. After one too many surprise bills, I decided to build a solution that would automatically clean up unused resources in Azure subscriptions.","date":"2025-04-12T00:00:00.000Z","tags":[{"inline":true,"label":"terraform","permalink":"/tags/terraform"},{"inline":true,"label":"azure","permalink":"/tags/azure"},{"inline":true,"label":"python","permalink":"/tags/python"},{"inline":true,"label":"function-app","permalink":"/tags/function-app"},{"inline":true,"label":"devops","permalink":"/tags/devops"}],"readingTime":4.3,"hasTruncateMarker":true,"authors":[{"name":"Chris O\'Malley","title":"Senior DevOps Engineer","page":{"permalink":"/authors/chris-omalley/"},"socials":{"linkedin":"https://www.linkedin.com/in/thecomalley/","github":"https://github.com/thecomalley"},"imageURL":"https://avatars.githubusercontent.com/u/31399219?v=4","key":"chris"}],"frontMatter":{"slug":"azure-sandbox-nuke","title":"Azure Sandbox Nuke","authors":["chris"],"tags":["terraform","azure","python","function-app","devops"]},"unlisted":false,"nextItem":{"title":"Deploying Python Function Apps to Azure with Terraform","permalink":"/terraform-azurerm-python-function"}}')}}]);